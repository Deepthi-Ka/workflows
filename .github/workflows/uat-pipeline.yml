name: non-prod pipeline
on:
  workflow_call:
    inputs:
      sha:
        type: string
        required: true      
      environment:
        name: please select env
        type: string
        required: true
permissions:
  contents: read
  statuses: write

job:
  uat-pipeline:
  runs-on: ubuntu-latest
  steps:
    - name: compute short commit
      id: commit
      run: |
        SHORT_SHA="${{ inputs.version }}"
        APP_VERSION= "${SHORT_SHA::0:9}"
        echo " app_version is ${app_version}"
        echo "$APP_VERSION" >> "$GITHUB_ENV"

    - name: check required commit statuses
      id: gate 
      shell: bash
      run: |
        echo "checking commit statuses for ${{ inputs.version }}"   
        
        REQUIRED_CONTEXTS=(
          "DEV_DEPLOY"
          "DOCKER_BUILD"
          "UNIT_TESTS"
          "SECURITY_CHECK"
        )

        RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/commits/${{ inputs.version }}/statuses")

          FAILED=0

        for CONTEXT in "${REQUIRED_CONTEXTS[@]}"; do
          STATE=$(echo "$RESPONSE" | jq -r \
            ".[] | select(.context == \"$CONTEXT\") | .state" | head -n 1)

        if [ -z "$STATE" ]; then
              echo "‚ùå $CONTEXT ‚Üí status missing"
              FAILED=1
            elif [ "$STATE" != "success" ]; then
              echo "‚ùå $CONTEXT ‚Üí $STATE"
              FAILED=1
            else
              echo "‚úÖ $CONTEXT ‚Üí success"
            fi
          done

        if [ "$FAILED" -eq 1 ]; then
            echo "üö´ UAT gate failed"
            exit 1
          fi

      echo "üéâ All required checks passed" 

    - name: configure aws credentials
      uses: aws-actions/configure-aws-credentials@v5.1.1
      with: 
        aws-region: us-east-1
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: authenticate to EKS
      run: | 
       aws eks update-kubeconfig  --region us-east-1 --name roboshop-dev
       kubectl get nodes

    - name: checkout catalogue deploy repo
      uses: actions/checkout@v6 
      with:
        repository: Deepthi-Ka/catalogue-deploy

    - name: deploy to ${{ inputs.environment }}  cluster
      id: UAT_DEPLOY
      run: " helm upgrade --install catalogue -f values-dev.yaml -n roboshop --set deployment.imageVersion=${APP_VERSION} --atomic --wait --timeout=5m ."
    
    - name: update deploy status
      if: always()
      uses: Deepthi-Ka/workflows/.github/actions/update-commit-status@main
      with:
       sha: ${{ inputs.version }}
       state: ${{ steps.UAT_DEPLOY.outcome }}
       context: UAT_DEPLOY
       description:  ${{ steps.UAT_DEPLOY.outcome }}



 
          


